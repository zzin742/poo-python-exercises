name: ğŸ§ª CorreÃ§Ã£o AutomÃ¡tica de ExercÃ­cios POO

on:
  pull_request:
    branches: [ main ]
    paths: 
      - 'respExercicio*.py'
      - 'Resposta_*.py'

jobs:
  test-exercises:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“‹ Detectar exercÃ­cios modificados
      id: detect-exercises
      run: |
        echo "Detectando exercÃ­cios modificados..."
        exercises=""
        for file in respExercicio*.py Resposta_*.py; do
          if [ -f "$file" ]; then
            exercises="$exercises $file"
          fi
        done
        echo "exercises=$exercises" >> $GITHUB_OUTPUT
        echo "ExercÃ­cios encontrados: $exercises"
    
    - name: ğŸ§ª Executar testes dos exercÃ­cios
      run: |
        echo "ğŸš€ Iniciando correÃ§Ã£o automÃ¡tica..."
        total_tests=0
        passed_tests=0
        failed_exercises=""
        
        for exercise_file in ${{ steps.detect-exercises.outputs.exercises }}; do
          if [ -f "$exercise_file" ]; then
            # Extrair nÃºmero do exercÃ­cio
            if [[ $exercise_file =~ respExercicio([0-9]+)\.py ]]; then
              exercise_num=$(printf "%02d" ${BASH_REMATCH[1]})
              test_file="tests/test_exercicio${exercise_num}.py"
            elif [[ $exercise_file =~ Resposta_([0-9]+)\.py ]]; then
              exercise_num=${BASH_REMATCH[1]}
              test_file="tests/test_exercicio${exercise_num}.py"
            else
              continue
            fi
            
            if [ -f "$test_file" ]; then
              echo "ğŸ“ Testando $exercise_file..."
              total_tests=$((total_tests + 1))
              
              if python -m pytest "$test_file" -v; then
                echo "âœ… $exercise_file: APROVADO"
                passed_tests=$((passed_tests + 1))
              else
                echo "âŒ $exercise_file: REPROVADO"
                failed_exercises="$failed_exercises $exercise_file"
              fi
            fi
          fi
        done
        
        echo "ğŸ“Š RESULTADO FINAL:"
        echo "Total de exercÃ­cios testados: $total_tests"
        echo "ExercÃ­cios aprovados: $passed_tests"
        echo "ExercÃ­cios reprovados: $((total_tests - passed_tests))"
        
        if [ $passed_tests -eq $total_tests ] && [ $total_tests -gt 0 ]; then
          echo "ğŸ‰ PARABÃ‰NS! Todos os exercÃ­cios foram aprovados!"
          exit 0
        else
          echo "âš ï¸  Alguns exercÃ­cios precisam de correÃ§Ã£o: $failed_exercises"
          exit 1
        fi
    
    - name: ğŸ“ Comentar resultado no PR
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Ler arquivos modificados
          const { execSync } = require('child_process');
          let exercises = [];
          
          try {
            const files = execSync('ls respExercicio*.py Resposta_*.py 2>/dev/null || true', { encoding: 'utf8' });
            exercises = files.trim().split('\n').filter(f => f);
          } catch (e) {
            console.log('Nenhum exercÃ­cio encontrado');
          }
          
          let comment = `## ğŸ§ª Resultado da CorreÃ§Ã£o AutomÃ¡tica\n\n`;
          
          if (exercises.length === 0) {
            comment += `âŒ **Nenhum arquivo de exercÃ­cio encontrado!**\n\n`;
            comment += `Certifique-se de nomear seus arquivos corretamente:\n`;
            comment += `- \`respExercicio01.py\`, \`respExercicio02.py\`, etc.\n`;
            comment += `- \`Resposta_10.py\` (para o exercÃ­cio 10)\n`;
          } else {
            comment += `ğŸ“‹ **ExercÃ­cios submetidos:** ${exercises.length}\n\n`;
            
            for (const exercise of exercises) {
              if (exercise) {
                comment += `- ğŸ“„ \`${exercise}\`\n`;
              }
            }
            
            comment += `\n---\n\n`;
            comment += `### ğŸ“Š Status dos Testes\n`;
            comment += `Os testes automÃ¡ticos verificam:\n`;
            comment += `- âœ… ExistÃªncia das classes solicitadas\n`;
            comment += `- âœ… ImplementaÃ§Ã£o correta dos mÃ©todos\n`;
            comment += `- âœ… Funcionamento dos conceitos de POO\n`;
            comment += `- âœ… Estrutura e relacionamentos entre objetos\n\n`;
            
            if (context.payload.pull_request.head.ref.includes('exercicio')) {
              comment += `ğŸ’¡ **Dica:** Verifique os logs do workflow para detalhes sobre falhas nos testes.\n`;
            }
          }
          
          comment += `\n---\n`;
          comment += `ğŸ¤– *CorreÃ§Ã£o automÃ¡tica realizada pelo GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });